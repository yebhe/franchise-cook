name: üöÄ D√©ploiement automatique sur AlwaysData

on:
  push:
    branches:
      - main   # ou master selon ton d√©p√¥t

jobs:
  deploy:
    name: D√©ployer sur AlwaysData
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout du d√©p√¥t
        uses: actions/checkout@v4

      - name: üîê Connexion SSH et d√©ploiement
        uses: appleboy/ssh-action@master
        with:
          host: ssh-${{ secrets.USERNAME }}.alwaysdata.net
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          script: |
            cd $HOME

            # Si ton projet n'est pas encore clon√©
            if [ ! -d "repo" ]; then
              git clone https://github.com/${{ github.repository }}.git repo
              cd repo
            else
              cd repo
              git pull origin main
            fi

            # Copier les fichiers dans le dossier www
            rsync -av --delete ./ $HOME/www/

            # Aller dans le dossier du projet
            cd $HOME/www/

            # Activer l'environnement virtuel (si tu l‚Äôas cr√©√©)
            if [ -f "$HOME/venv/bin/activate" ]; then
              source $HOME/venv/bin/activate
            fi

            # Installer les d√©pendances
            pip install -r requirements.txt

            # Appliquer les migrations
            python manage.py migrate --noinput

            # Collecter les fichiers statiques
            python manage.py collectstatic --noinput

            echo "‚úÖ D√©ploiement termin√© avec succ√®s sur AlwaysData !"
